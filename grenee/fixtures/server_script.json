[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-05-27 15:11:45.133994",
  "module": "Grenee",
  "name": "Check User Slot",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "User",
  "script": "franchise_role = \"Franchise User\"\n\nhas_role = False\nfor role in doc.get('roles'):\n\tif role.role == 'Franchise User':\n\t\thas_role = True\n\t\tbreak\n\nuser_slot = frappe.get_all(\"User Slot\", filters={\"user\": doc.name}, limit=1)\n\nif has_role:\n    if not user_slot:\n        current_time = frappe.utils.now_datetime().time().replace(microsecond=0)\n        \n        get_slot = frappe.get_doc(\"Slot\")\n        start_time = frappe.utils.get_time(get_slot.start_time)\n        end_time = frappe.utils.get_time(get_slot.end_time)\n        slot = \"Open\" if start_time < current_time < end_time else \"Closed\"\n\n        user_slot_doc = frappe.get_doc({\n            \"doctype\": \"User Slot\",\n            \"user\": doc.name,\n            \"slot\": slot\n        })\n        user_slot_doc.insert()\n        user_slot_doc.submit()\nelse:\n    if user_slot:\n        user_slot_name = user_slot[0].name\n        user_slot_doc = frappe.get_doc(\"User Slot\", user_slot_name)\n        if user_slot_doc.docstatus == 1:\n            user_slot_doc.cancel()\n        frappe.delete_doc(\"User Slot\", user_slot_name)",
  "script_type": "DocType Event"
 }
]